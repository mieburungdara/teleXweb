# Telegram Bot System Concept

The bot acts as the entry point for files into the system.

*   **Method: Webhook**
    *   A more efficient method than long polling. A single PHP script (`webhook.php`) will be created and its URL will be registered with the Telegram Bot API.
    *   **`webhook.php` Script:**
        1.  **Receive Update:** Telegram will send a POST request with a JSON payload to this script whenever a new message (or file) is sent to the bot.
        2.  **Validate:** The script will perform a basic check to ensure the request is from Telegram (e.g., by checking a secret token).
        3.  **Proses Metadata File:** Jika pembaruan berisi file, skrip akan:
            a.  Mengekstrak `file_id`, `file_name` (jika tersedia), `mime_type`, dan `file_size` dari payload JSON.
            b.  Tidak akan mengunduh file fisik.
        4.  **Teruskan ke CodeIgniter:** Skrip kemudian akan membuat permintaan cURL ke endpoint API CodeIgniter (`/api/upload`), mengirimkan metadata file yang diekstrak (Telegram user ID, `telegram_file_id`, original filename, MIME type, ukuran file, dll.).
        5.  **Respon ke Telegram:** Skrip mengirimkan respons `200 OK` ke Telegram untuk mengakui penerimaan pembaruan. Ini juga dapat secara opsional mengirim pesan konfirmasi kembali ke pengguna melalui API bot.

## Bot Commands

The bot will support the following commands to provide a better user experience:

*   **/start**: Displays a welcome message and a brief introduction to the bot's purpose.
*   **/help**: Provides a detailed help message explaining how to send files and use other available commands.
*   **/recent `[N]`**: Allows the user to request their last `N` files (defaulting to 5 if `N` is not provided). The bot will retrieve the metadata from the database and send the corresponding files back to the user by using the stored `telegram_file_id`.
*   **/search `[keyword]`**: Searches the `original_file_name` and `tags` columns in the database for the provided keyword. The bot will return a list of matching files, or send the files directly if the result count is low.

## Admin Notifications

The bot will also serve as a notification channel for the system administrator:

*   **Failure Alerts:** In case of critical system errors (e.g., webhook processing failure, database connection loss), the system will trigger the bot to send an immediate alert to a pre-configured admin Telegram account.
*   **Scheduled Reports:** The bot will be used to send periodic (e.g., weekly, monthly) summary reports generated by a cron job, detailing statistics like new files added, most active users, etc.

## Bot Interaction for Purchased Folder Content Delivery

1.  **Deep-link Generation:** Upon successful purchase of a folder, a unique Telegram deep-link will be generated for the buyer. This deep-link will be in the format `https://t.me/YourBotName?start=folder_access_<folder_id>_<buyer_user_id>`.
2.  **Bot `/start` Command Handling:**
    *   When a user clicks this deep-link, the bot receives a `/start` command with a payload (e.g., `folder_access_<folder_id>_<buyer_user_id>`).
    *   The bot will parse this payload to extract the `folder_id` and `buyer_user_id`.
    *   The bot will then verify that the `buyer_user_id` matches the user interacting with the bot, and that the user has indeed purchased the specified `folder_id` (by querying the `folder_purchases` table).
3.  **Content Delivery:**
    *   If the verification is successful, the bot will retrieve all file metadata associated with the `folder_id` from the `files` table.
    *   For each file, the bot will use the `copyMessages` Bot API method to forward the file from the designated storage channel (`storage_channel_id`, `storage_message_id`) to the user.
    *   The bot will send a confirmation message to the user upon successful delivery.
    *   Error handling will be implemented for cases where files cannot be found or forwarded.
4.  **Access Control:** The bot will ensure that only the legitimate buyer can access the content via their unique deep-link. The deep-link should ideally be single-use or time-limited for security, though for simplicity initially, it might be persistent.
5.  **User Experience:** The process should be seamless for the user, providing clear feedback on the status of content delivery.


